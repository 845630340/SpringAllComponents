## 创建工程

### 一、简介

用户通过新建工程关联您的代码源（目前仅支持GitLab，全局配置中添加仓库），单击项目详情中“创建工程“按钮进行新建；

##### 操作流程
![image](https://domeos-pics2.bjcnc.scs.sohucs.com/%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B.png)
如流程所示，创建工程页需要用户填写工程名字、选取是否使用代码仓库、是否复制Dockerfile。目前支持使用多个代码项目，只能拉取在同一仓库同一账户下拥有Master权限的代码项目。

若不使用代码仓库不影响工程构建，即使没有代码源，只要配置好Dockerfile即可构建镜像。

选择所关联仓库和账户后，点击代码项目右侧的“+“在弹窗中配置代码信息，可按提示点击代码项目名对已经配置的代码进行更换，也可添加多个代码项目。

### 二、基本信息

#### 工程名称

工程名称即是构建后生成的镜像名称，创建后不可更改。

#### 代码仓库

代码仓库用于选择将要构成镜像的代码。

代码仓库选项，可在 "全局设置-代码仓库" 中自定义管理，目前仅支持GitLab代码源。

用户也可以不使用代码仓库，不影响构建镜像。

#### 仓库用户

选择指定 "代码仓库" 后，用户需要关联账户到该代码仓库，然后才能在之后的 "代码项目" 中，看到该关联用户在当前代码仓库中拥有的Master权限项目。

若当前代码仓库已有账户关联，可以进行 "重新关联" 其他账户，即可看到其他账户的Master权限项目。详情见下图：

![image](https://domeos-pics2.bjcnc.scs.sohucs.com/%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%8101.png)

#### 代码项目

可以选择多个代码项目进行构建镜像。见下图：

![image](https://domeos-pics2.bjcnc.scs.sohucs.com/%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%8102.png)

每个代码项目的详情如下图：

![](http://domeos-pics.bjcnc.scs.sohucs.com/代码项目GIT20210526.png)

- 代码项目名称：鼠标移动至蓝色名称上，可按提示可以点击修改代码项目

- 存放路径：镜像内存放代码的绝对路径，代码仓库中的代码将被下载到此路径，默认为根目录
- 获取方式：分为GIT、HTTPS两种拉取代码方式，默认为GIT方式
- 运行程序令牌：若选取HTTPS拉取方式，用户需要去自己的gitlab账户下，获取Access Tokens

#### 复制配置

**声明Dockerfile的两种来源，详细介绍如下：**

- 创建新的配置：可以根据下面四种 "配置方式" 自由定义Dockerfile文件。

- 以现有项目配置为蓝图：只能选择已有项目的Dockerfile文件，"配置方式" 自动选择 "代码内Dockerfile"。

#### 配置方式

**Dockerfile是一种text类型的配置文件，Docker通过读取此文件自动构建镜像。"配置方式" 选项提供不同的方式，来生成Dockerfile文件。**

**目前提供四种配置方式，用户可按需选择，详细介绍如下：**

###### 1、代码内Dockerfile
该方式支持所拉取代码内已存在的Dockerfile，无需在DomeOS中配置构建参数生成Dockerfile，仅需配置以下几项参数：
![image](http://domeos-pics.bjcnc.scs.sohucs.com/代码内Dockerfile20210406.png)

- Dockerfile文件名：镜像内的Dockerfile文件名。文件名可随意命名，推荐在构建目录下存放Dockerfile。
- 构建路径：代码项目内执行docker build命令的绝对路径参数，默认根路径。

###### 2、定制化配置
该方式支持用户自己编写Dockerfile，仅需配置以下两个参数：
![image](https://domeos-pics2.bjcnc.scs.sohucs.com/%E5%AE%9A%E5%88%B6%E5%8C%96dockerfile.png)

- Dockerfile：用户自行填写Dockerfile，可选择基础镜像作为Dockerfile的base。注意：ADD指令可以通过URL获取网络资源，COPY指令无效。
- 配置文件：作为镜像的配置文件以二进制文件形式存储，用户可指定包含文件名的存放路径（绝对路径）。

###### 3、通用配置
该方式适合不会编写Dockerfile的用户，可以从选择最底层镜像开始通过配置以下参数直接生成Dockerfile，详细介绍如下：
![image](http://domeos-pics.bjcnc.scs.sohucs.com/通用配置20210406.png)

- 镜像：选择底层镜像，包括基础镜像和项目镜像。
- 编译命令： 执行代码编译的命令，示例：构建python项目镜像，通过pip命令安装依赖包。(多条命令使用&&连接)
- 编译环境变量：编译过程中的环境变量，将被写入Dockerfile，构建、运行过程中都会生效。
- 启动命令：指定容器启动后在容器内要立即执行的指令，一般为代码启动命令。(多条命令使用&&连接)
- 工作路径：代码工作路径，若不存在会自动创建。(注意：要求为绝对路径，默认为根目录)
- 容器用户： 指定启动容器的用户，默认为超级用户。
- 配置文件模板- 若需使用dockerize配合配置模板生成配置文件，这里需要配置模板文件在代码项目中的路径以及生成配置文件的目标路径，可配置多对。

###### 4、两步构建
该类型适合不会编写dockerfile且需要**将编译和运行分开**的用户，例如典型的Java项目，可以通过分别配置以下编译和运行参数生成Dockerfile。

注意：不使用代码仓库时，无法使用"两步构建"方式进行配置。

![image](http://domeos-pics.bjcnc.scs.sohucs.com/两步构建20210406.png)

- 编译镜像：DomeOS官方仓库中提供了部分maven、jdk和golang镜像可以用于Java项目和Go项目构建，也可以选择私有仓库中镜像用于构建。
- 编译脚本：一般为打包构建命令，比如mvn package、go build等。
- 编译阶段环境变量：该环境变量只在编译阶段有效。
- 编译阶段存放路径：编译结果在编译镜像中的存放路径。编译脚本会在代码路径（设置在基本信息的代码项目中）下执行，假如代码路径为根目录，编译脚本为maven打包命令，所以正常情况，会在根目录下生成 target、groovy 两个文件夹，target中包含项目jar包或war包，如果你想将jar包与groovy文件夹拷贝到运行阶段的存放路径中，此时编译阶段存放路径应该为 /target/xxx.jar 与 /groovy 。



- 运行镜像：DomeOS官方仓库中提供了部分tomcat和jre镜像可用于运行Java项目，也可以选择私有仓库中镜像用作为运行镜像。
- 运行阶段存放路径：编辑阶段存放路径中的内容，会存放到该路径下（注意：要求为绝对路径）。
- 编译命令：可用于安装运行程序所需的一些依赖库，多条命令请用 && 连接。
- 启动命令：运行镜像容器启动后，立即执行的命令，例如：java  -jar  xxx.jar。
- 工作路径： 代码工作路径，若不存在则自动创建（注意：要求为绝对路径，默认为根目录）。
- 容器用户：指定启动容器的用户，默认为超级用户。
- 配置文件模板- 若需使用dockerize配合配置模板生成配置文件，这里需要配置模板文件在代码项目中的路径以及生成配置文件的目标路径，可配置多对。

#### 完成配置

配置完成后，可以点击"预览Dockerfile"查看根据配置生成的Dockerfile的内容。
点击"完成创建"即可完成工程的创建。


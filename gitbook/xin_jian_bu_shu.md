## 新建部署

在部署列表页面上点击“新建部署”可将镜像部署到服务内。
![image](https://domeos-pic3.bjcnc.scs.sohucs.com/%E9%83%A8%E7%BD%B2%E5%88%97%E8%A1%A8.png)

### 部署配置

#### 基本信息
![image](https://domeos-pic3.bjcnc.scs.sohucs.com/%E5%88%9B%E5%BB%BA%E9%83%A8%E7%BD%B201.png)

- 部署名称：该名称会作为内网域名的一部分，要求符合dns命名规范。
- 部署描述：部署的详情描述，默认为空，可不填。
- 资源包：部署实例将会调度到资源包中的主机节点上。
- 部署类型：目前支持Kubernetes的Deployment、DaemonSet、StatefulSet三种类型
- - Deployment: 该类型部署启动的实例数由用户指定，选定主机上启动的实例个数不固定；
- - DaemonSet: 该类型部署在选定的主机上启动且只启动一个实例；
- - StatefulSet: 该类型部署经常用于管理调度有状态的部署，部署具有固定的名字以及固定的升级顺序。
- 网络模式：可以选择使用Overlay或Host网络模式部署
- - Overlay：Overlay 模式使用 flannel（backend使用vxlan）管理容器网络;
- - Host：如果想设置对外暴露端口个数，需要设置环境变量NEED_PORTS，更多host相关说明，详见“Host网络”部分。
- 集群内访问：勾选后需要配置服务端口，可以选择配置粘性会话。
- 集群外访问：勾选后需要配置对外IP、服务端口，可以选择配置粘性会话。

#### 镜像配置
![image](http://domeos-pics.bjcnc.scs.sohucs.com/新建部署版本信息20210408.png)

- 容器设置： 用户可以在一次部署时选择多个镜像同时部署。每个镜像会启动一个容器，各个镜像的容器整体构成一个实例（Pod），实例是部署运维管理的最小单位。选好镜像后，您需要对每个镜像进行配置。
![image](https://domeos-pic3.bjcnc.scs.sohucs.com/%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE.png)
- - 资源配额：可以配置容器使用的CPU和内存资源，后端将容器的Request和Limit的值设置为一样的，此处CPU配置的核并不是真正绑定某个核，具体概念可以参考cpushares。
- - 拉取策略：目前支持Always（不管本地是否存在该镜像，都会去私有仓库拉取一遍）、Never（即使本地没有该镜像，也不会尝试去私有仓库拉取）、IfNotPresent（如果本地没有该镜像，就会尝试去私有仓库拉取）。
- - 启动命令：启动命令和参数一起填写。如果此处填写了启动命令和参数，会覆盖镜像中的ENTRYPOINT和CMD。
- - 挂载存储：需要指定存储类型、挂载类型、存储挂载路径及该存储所挂载容器的具体位置。目前DomeOS支持的存储类型有宿主机目录、实例内目录和存储数据卷三种，挂载类型有只读和读写两种，容器内挂载路径需要指定到运行容器的绝对路径。
![image](https://domeos-pic3.bjcnc.scs.sohucs.com/%E6%8C%82%E8%BD%BD%E5%AD%98%E5%82%A8.png)

- - - 宿主机目录(HostPath)：容器内挂载路径中所有文件会同步到主机目录，实例销毁时挂载的文件依然存在于宿主机上。
- - - 实例内目录(EmptyDir)：为了一个实例内多个容器共用分享存储文件时使用，该路径下所有存储文件与实例具有相同的生命周期，当实例销毁时所有文件也立即销毁。 
- - - 存储数据卷（PVC）：该功能使用Panther云盘功能进行挂载，使用前需要在Panther申请开通并创建云盘，并在资源包中绑定已有云盘。容器接入网络存储的方式，容器内挂载路径中所有文件会同步到云盘目录（存储数据卷的关联请查看[资源包详情](zi_yuan_bao_xiang_qing.md)）。当使用statefulset类型部署时，会出现动态存储选择框，当勾选时，每个statefulset的实例将挂载该云盘目录下的不同的子目录，该子目录由DomeOS负责创建，并在与DomeOS解绑定时触发销毁，否则，所有实例均相同的挂载该存储卷，此时需要注意多实例读写的问题。

- - 日志收集：需要输入日志文件的所在路径，并选择是否自动收集和自动删除。
日志收集采用kafka+flume形式，通过flume采集日志并上传到kafka里，要使用日志收集功能需要在集群下配置日志收集参数，日志收集功能只针对默认类型配置。 日志收集时我们会在启动pod中增加一个flume镜像，镜像内容可以参考： https://github.com/domeos/domeos-flume 可以根绝该开源flume镜像进行相应的定制化。 日志收集分为自动收集日志与自动删除日志：
![image](https://domeos-pic3.bjcnc.scs.sohucs.com/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86.png)
  如上图所示，自动收集日志与删除日志都需要针对到具体的文件名，日志topic是需要提前在kafka中创建，flume的日志收集镜像是通过配置了tail -F $LOGFILE进行日志，可以在之后增加具体的预处理命令，该命令必须以 "|" 开头， 删除日志是距上次文件修改时间起多少小时触发删除命令。
- - 环境变量：环境变量的值必须符合[A-Za-z_][A-Za-z0-9_]*正则表达式。
- - 配置文件：为方便管理维护程序的配置文件，可根据需要将配置文件挂载出来。
- - 健康检查：根据配置的检查规则来判定部署实例是否健康，如果不健康就重启该部署实例。
- - 就绪性检查：根据配置的规则来检查实例能否访问；配置该项时，通过对内服务或对外服务访问部署时，请求只被转发到就绪状态的实例；非就绪状态的实例不会被重启。
- - 自动升级：仅当部署正在运行时生效；此功能不支持多版本运行的部署。
- - 高级调度：配置此选项后可以要求实例有 必须部署在相同主机/必须不在相同主机/尽量在相同主机/尽量不在相同主机  这四种部署方式，其中包含必须的部署要求如果资源不足时会触发Pending，包含尽量的部署要求当资源不足时会去掉高级调度选项重新进行调度，如果此时仍资源不足才会触发Pending。
- 实例终止：可设定收到SIGTERM信号多久后，如果容器实例仍未退出，使用 SIGKILL 信号强制终止实例。
- Hosts：通过追加方式配置容器实例中/etc/hosts的内容。
- 主机标签：通过主机标签限制约束部署实例调度的主机节点。
      

完成所有配置后，点击“提交”。
